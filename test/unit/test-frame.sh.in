#!@SH_PROG@
# -*- shell-script -*-
PS4='(%x:%I): [%?] zsh+ 
'

typeset -a _Dbg_frame_stack
setopt ksharrays

test_frame()
{
    _Dbg_frame_save_frames 0
    assertEquals 5 ${#_Dbg_frame_stack[@]}
    _Dbg_set_basename=1
    typeset _Dbg_frame_filename=''
    _Dbg_frame_file a b c
    assertNotEquals 0 "$?"
    _Dbg_frame_filename=''
    _Dbg_frame_file 
    assertEquals 0 "$?"
    assertEquals 'test-frame.sh' "$_Dbg_frame_filename"
}

test_frame_adjust()
{
    _Dbg_errmsg() {
	errmsg+=("$1")
    }
    _Dbg_running=1
    typeset -a errmsg; errmsg=()
    _Dbg_frame_save_frames 0
    assertEquals 5 ${#_Dbg_frame_stack[@]}

    # Test frame_adjust parameter checking
    _Dbg_frame_adjust a
    _Dbg_frame_adjust
    assertNotEquals 0 "$?"

    # Test absolute positioning - ok values (0..3)
    for i in 0 1 2 3 -1 -2 -3; do
	_Dbg_frame_adjust $i 0
	assertEquals 0 ${#errmsg[@]}
    done

    # Test invalid values
    for pair in '5 0' '5 -1' '4 +1' '-6 0'; do 
	unset errmsg; errmsg=()
	local _Dbg_stack_pos=2  # Bug if typeset is used.
	_Dbg_frame_adjust $pair
	assertNotEquals 0 "$?"
	assertNotEquals 0 ${#errmsg[@]}
    done
}

# Make sure @abs_top_srcdir@ has a trailing slash
if [ '@abs_top_srcdir@' = '' ] ; then
  echo "Something is wrong: abs_top_srcdir is not set."
 exit 1
fi
abs_top_srcdir=@abs_top_srcdir@
abs_top_srcdir=${abs_top_srcdir%%/}/

_Dbg_libdir=$abs_top_srcdir
set -- '-q'  # Don't need to show banner
. ${abs_top_srcdir}dbg-pre.sh
. $abs_top_srcdir/lib/file.sh
. $abs_top_srcdir/lib/filecache.sh
. $abs_top_srcdir/lib/fns.sh
. $abs_top_srcdir/lib/gdb.sh
. $abs_top_srcdir/lib/msg.sh
. $abs_top_srcdir/lib/run.sh
. $abs_top_srcdir/lib/frame.sh

set -o shwordsplit
SHUNIT_PARENT=$0

# load shunit2
srcdir=@srcdir@
shunit_file=${abs_top_srcdir}test/unit/shunit2
. ${shunit_file}
